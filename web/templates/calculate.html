{% extends 'base.html' %}

{% block content %}
<div class="row" style="--bs-gutter-x: 0;">
    <div class="col gy-2 gx-5">
        <div class="card shadow" style="max-width: 33vh;" id="info">
            <div id="card_content" class="container gy-3">
                {% if response_data.error_addresses | length > 0 %}
                <div class="justify-content-left">
                    <p>We couldn't find some addresses:</p>
                </div>
                    {% for location in response_data.error_addresses %}
                <div class="text-justify">
                    <p>{{ location.source_location }}</p>
                </div>
                    {% endfor %}
                <a href="/">
                    <p class="d-flex justify-content-left">Click here to try again</p>
                </a>
                {% else %}
                    {% if response_data.result_locations | length == 0 %}
                <div class="text-justify">
                    <a href="/">
                        <p class="d-flex justify-content-left">We didn't find any suitable locations, click here to try again with a larger travel time</p>
                    </a>
                </div>
                    {% elif response_data.result_locations | length > 5 %}
                <p class="d-flex justify-content-left"><a href="/">We found a lot of results, you might want to reduce
                        the travel time - click here to search again</a></p>
                    {% endif %}
                    {% if response_data.result_locations | length > 0 %}
                <p class="d-flex justify-content-left">Here's some places we found within {{ response_data.travel_time }} minutes:</p>
                        {% for location in response_data.result_locations %}
                <div class="text-justify">
                    <a href="https://www.google.com/maps/@{{ location.centre_latitude }},{{ location.centre_longitude }},16z"
                        target="_blank" rel="noopener noreferrer">
                        <p>{{ location.centre_location }}</p>
                    </a>
                </div>
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    {% if response_data.source_addresses | length > 0 %}
    <div id="map" class="fill position-fixed"></div>
    {% endif %}
</div>

<script>
    // Initialize and add the map
    function initMap() {
        var bounds = new google.maps.LatLngBounds();
        const centre = { lat: {{ response_data.map_centre.latitude }}, lng: {{ response_data.map_centre.longitude }} };
        const map = new google.maps.Map(document.getElementById("map"), {
            //zoom: {{ response_data.map_centre.zoom }},
            center: centre,
            disableDefaultUI: true,
        });
        // Add source markers
        {% for source_location in response_data.source_addresses %}
        const source_address_{{ loop.index }} = new google.maps.Marker({
            position: { lat: {{ source_location.latitude }}, lng: {{ source_location.longitude }} },
            map: map,
        });
        bounds.extend(source_address_{{ loop.index }}.getPosition())
        {% endfor %}
        // Add shell overlays
        {% for shell in response_data.result_locations %}
        const shell{{ loop.index }}_coords = {{shell.shell_edges | safe}}
        const shell{{ loop.index }} = new google.maps.Polygon({
            paths: shell{{loop.index}}_coords,
            strokeColor: "#878787",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#878787",
            fillOpacity: 0.35,
        })
        shell{{loop.index}}.setMap(map);
        {% endfor %}
        map.fitBounds(bounds, 96);
    }

    map = window.initMap = initMap;
    document.getElementById("map").style.zIndex = "1";
    document.getElementById("info").style.zIndex= "3";
</script>
<script
    src="https://maps.googleapis.com/maps/api/js?key={{ response_data.maps_api_key }}&callback=initMap&v=weekly"
    defer></script>

{% endblock %}